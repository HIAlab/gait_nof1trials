---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 


```{r} 
# ANOVA following tutorial at: http://web.pdx.edu/~joel8/resources/ConceptualPresentationResources/JAGS_ANOVA.pdf

library(rjags)
library(lattice)
library(knitr)
library(dplyr) 
library(tidyr)
# library(kableExtra)
# for nice display of inline code 
opts_chunk$set(echo=TRUE, comment='') 
# for nicely formatted tables 
options(knitr.table.format = "latex")

# generate data
mdat = list('grp'=gl(3,4), 'ngrp'=3, 'N'=12, 'y'=c(2,1,3,2, 2,6,2,2, 6,10,7,5))
# quick visualization of the data
disp.mdat = matrix(mdat$y,ncol=mdat$ngrp,
                   dimnames = list(paste('obs',1:(mdat$N/mdat$ngrp),sep=' '),
                                   paste('group',1:mdat$ngrp,sep=' '))) 

disp.mdat
```


```{r load our gait data}

load_gait_parameters <- function (folder_path, keyword, subject, test, cond) {
  
  #### first find file name by keyward ####
  file_path <- c()
  kw_fn_list <- list()  # keyword - file name pairs
  kw_fn_list[[ "LF" ]] <- "left_foot_core_params_py_n.csv"
  kw_fn_list[[ "RF" ]] <- "right_foot_core_params_py_n.csv"
  kw_fn_list[[ "LFRF_windowed" ]] <- "agg_windows_control_fatigue_st_dt_10_2.csv"

  # look up file names
  if (keyword %in% names(kw_fn_list)) {
    file_name <- kw_fn_list[[keyword]]
  }
  else {
    return(paste("Keyword", keyword, "does not exist!"))
  }
  
  #### then load the data ####
  if (grepl("windowed", keyword, fixed = TRUE)) {
    folder_path <- file.path("../../fatigue_gait/data_publish/processed", "features")
    data_path <- file.path(folder_path, file_name)
    dat_df <- readr::read_csv(data_path, col_names = T, show_col_types = FALSE)
    # dat_df <- dat_df[(dat_df$)]
  }
  else {
    folder_path <- file.path("../../fatigue_gait/data_publish/processed", paste0("OG_", cond, "_", test), sub)
    data_path <- file.path(folder_path, file_name)
    dat_df <- readr::read_csv(data_path, col_names = T, show_col_types = FALSE)
    # remove outlier strides
    loc_df <- loc_df[(dat_df$is_outlier == FALSE) & 
                     (dat_df$turning_interval == FALSE) & 
                     (dat_df$interrupted == FALSE),
                     ]
  }
  
  data_path <- file.path(folder_path, file_name)
  dat_df <- readr::read_csv(data_path, col_names = T, show_col_types = FALSE)
  
  return(dat_df)
}


## load & concat .csv file
# dataset <- "fatigue_dual_task"
cond_list <- list("dt", "st")
test_list <- list("fatigue", "control")
IMU_loc <- list('LFRF_windowed')  # LFRF_windowed, LF, RF
kw <- IMU_loc[[1]]  # safety measure, for now we only load one location at a time

sub_list <- list(  # for n-of-1 trials, select only one subject!
  # "sub_01"
  # "sub_02",
  # "sub_03",
  # "sub_05",
  # "sub_06",
  # "sub_07",
  "sub_08"
  # "sub_09",
  # "sub_10",
  # "sub_11",
  # "sub_12",
  # "sub_13",
  # "sub_14",
  # "sub_15",
  # "sub_17",
  # "sub_18"
  )

# file_path <- file.path("../../fatigue_gait/data/processed", "features", "fatigue_dual_task", "agg_windows_control_fatigue_st_dt_10_2.csv")
#   
# dat <- readr::read_csv(file_path, col_names = T)

if (grepl("windowed", kw, fixed = TRUE)) {
  # read windowed parameters from only one file
  loc_df <- load_gait_parameters(folder_path, kw,  sub, test, cond)
  print(nrow(loc_df))
} else {
  # read all data for one IMU location
  loc_df <- data.frame()
  for (cond in cond_list) {
    for (test in test_list) {
      for (sub in sub_list) {
        for (kw in IMU_loc) {
          dat_df_temp <- load_gait_parameters(folder_path, kw, sub, test, cond)
          dat_df_temp["fatigue"] <- test
          dat_df_temp["condition"] <- cond
          loc_df <- bind_rows(loc_df, dat_df_temp)
        }
      }
    }
  }
}


# select list of features
features_list <- c(
  'stride_lengths_avg'
  # 'clearances_min_avg', 
  # 'clearances_max_avg',
  # 'stride_times_avg', 
  # 'swing_times_avg', 
  # 'stance_times_avg',
  # 'stance_ratios_avg', 
  # 'cadence_avg', 
  # 'speed_avg', 
  # 'stride_lengths_CV',
  # 'clearances_min_CV', 
  # 'clearances_max_CV', 
  # 'stride_times_CV',
  # 'swing_times_CV', 
  # 'stance_times_CV', 
  # 'stance_ratios_CV', 
  # 'cadence_CV',
  # 'speed_CV', 
  # 'stride_lengths_SI', 
  # 'clearances_min_SI',
  # 'clearances_max_SI', 
  # 'stride_times_SI', 
  # 'swing_times_SI',
  # 'stance_times_SI', 
  # 'stance_ratios_SI', 
  # 'cadence_SI', 
  # 'speed_SI'
)

# compose the datafram used for further analysis
dat_df <- filter(loc_df, sub == sub_list[1])
dat_df <- dat_df[, c(features_list, "fatigue", "condition", "sub")]

```

```{r}
# re-format the dataframe to match likelihood model input format
dat_df$group <- paste0(dat_df$condition, "_", dat_df$fatigue)
dat_df <- dat_df[, c(features_list, "group")]
mdat_df <- dat_df
# mdat_df <- reshape(mdat_df, direction = "wide", timevar = "group")
mdat_df <- spread(
  data = mdat_df,
  key = "group",
  value = features_list
)
# mdat = list('grp'=gl(3,4), 'ngrp'=3, 'N'=12, 'y'=c(2,1,3,2, 2,6,2,2, 6,10,7,5))
# mdat <- list(
#   
# )
# quick visualization of the data
# disp.mdat = matrix(mdat$y,ncol=mdat$ngrp,
#                    dimnames = list(paste('obs',1:(mdat$N/mdat$ngrp),sep=' '),
#                                    paste('group',1:mdat$ngrp,sep=' '))) 
```

#![Here is a Crab](images/bayes_thereom.png)
#![Here is a Crab](images/bayes_thereom_linear_regression.png)

```{r}
# specify the likelihood model
mt = ' model{
  for(i in 1:N){
  y[i] ~ dnorm(mu[i], err.prec) 
  mu[i] = alpha + beta[grp[i]]
  }
  err.prec ~ dgamma(1.0E-3,1.0E-3) 
  rse = pow(err.prec,-.5)
  alpha ~ dnorm(0,1.0E-3)
  
  beta[1] = 0
  for(i in 2:ngrp){
  beta[i] ~ dnorm(0,1.0E-3) 
  }
}'
# compile the model in JAGS
ti = textConnection(mt)
cm = jags.model(ti, data=mdat, # model specification and data.
                n.chains=2, # two random walkers
                # initial values, one set per chain 
                inits=list(
                list('alpha'=0,'beta'=c(NA,.5,.5)),
                list('alpha'=2,'beta'=c(NA,1,5))),
                # burn-in/adaptation steps before we trust
                n.adapt = 1000, quiet=TRUE)
close(ti) # clean up
# run the chains longer 
update(cm,5000)

#### Monitoring the Postreriors
# track the progress of our walkers relative to our parameters of interest 
pos = coda.samples(cm, # our compiled model
                   # parameters of interest to monitor
                   variable.names=c('alpha','beta','rse'), 
                   n.iter=5000) # steps to follow
```

```{r Visualization}
xyplot(window(pos,start=5001,stop=10000))
```

```{r diagnostics using z-score differences}
geweke.diag(window(pos,start=5001,stop=10000))
```

```{r Reporting}

summary_table <- summary(window(pos,start=5001,stop=10000))$statistics
summary_table

print(' ')

# Hypothesis testing of parameters?
quantile_table <- summary(window(pos,start=5001,stop=10000))$quantiles
quantile_table
```

```{r compare to OLS}
# How does this compare to OLS?
summary(lm(y~grp,mdat))$coefficients
```



```{r}
# following tuturial at: http://www.jkarreth.net/files/bayes-cph_Tutorial-JAGS.pdf
library(R2jags)
# An example model file is given in:
model.file <- system.file(package = "R2jags", "model", "schools.txt") 
# data
J <- 8.0
y <- c(28.4,7.9,-2.8,6.8,-0.6,0.6,18.0,12.2)
sd <- c(14.9,10.2,16.3,11.0,9.4,11.4,10.4,17.6) 
jags.data <- list("y","sd","J")
jags.params <- c("mu","sigma","theta")
jags.inits <- function(){  
  list("mu"=rnorm(1),"sigma"=runif(1),"theta"=rnorm(J))
}
jagsfit <- jags(data=list("y","sd","J"), inits = jags.inits, jags.params, n.iter = 10, model.file = model.file)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

